### 1.批量模板落地脚本
```
#!/bin/sh
# ==========================================================
# 第1个参数是hive表名，第2个参数是Oracle表名
# 第3个参数是etl_date
# 第4个参数是 site 第5个参数是 lang
# 注意，site lang参数目前没有做校验，必须提供正确值
# ==========================================================
source /etc/profile
source ~/.bash_profile
source /dw/config/hive_config.conf
#日期时间YYYY-MM-DD
#日期时间YYYY-MM-DD
stryesday=`date -d last-day +%Y-%m-%d`
strtoday=`date +%Y-%m-%d`
echo $stryesday
echo $strtoday

echo '程序绝对路径为'`dirname $0`
this_sh_abs_path=`dirname $0`
echo $this_sh_abs_path

if [ -z $1 ]; then
  echo '请输入源表表名:'
  exit
fi

if [ -z $2 ]; then
  echo '请输入目标表表名:'
  exit
fi

if [ -z $3 ]; then
  this_etl_date=$stryesday
 else
  this_etl_date=$3
fi
etl_date=$this_etl_date
write_log "[INFO]" "$2" "exp_file_start" "$this_etl_date" "数据智囊$1--$2文件落地开始"

echo $this_sh_abs_path/config/sjzn_prj_v3.conf
#读取项目配置文件
if [ -f $this_sh_abs_path/config/sjzn_prj_v3.conf ]; then
    this_prj_root_path=`cat $this_sh_abs_path/config/sjzn_prj_v3.conf|grep 'sjzn_prj_root_path'| awk -F'[=]' '{print $2}'`
   if [ -z '$this_prj_root_path' ]; then
      echo  '配置文件中未找到sjzn_prj_root_path配置项，程序退出'
      exit
    else
      echo  'this_prj_root_path:'$this_prj_root_path
   fi


   this_data_root_path=`cat $this_sh_abs_path/config/sjzn_prj_v3.conf|grep 'sjzn_prj_data_root_path'| awk -F'[=]' '{print $2}'`
   if [ -z '$this_data_root_path' ]; then
      echo  '配置文件中未找到sjzn_prj_data_root_path配置项，程序退出'
      exit
    else
      echo  'this_data_root_path:'$this_data_root_path
   fi
   
else
   echo '项目配置文件prj.conf not found.exit......'
   exit
fi


#读取应用层每个表的配置信息
this_tb_conf=`cat $this_sh_abs_path/config/sjzn_prj_tb_v3.conf|grep $1'|'$2`

if [ -z $this_tb_conf ]; then
   echo "在sjzn_tb.conf中未找到配置信息$1|$2" 
   exit 
 else 
   echo  "配置信息为$this_tb_conf"
fi

# ---- test -----
# exit
# ---- test -----


#落地路径 site lang
this_tb_path=`echo $this_tb_conf |awk -F'[|]'  '{print $3}'`
this_tb_path=${this_tb_path//__site__/$4}
this_tb_path=${this_tb_path//__lang__/$5}
#AB接口方式:AB/APP
this_tb_abtest=`echo $this_tb_conf |awk -F'[|]'  '{print $5}'`   
#刷新周期:D/M
this_tb_period=`echo $this_tb_conf |awk -F'[|]'  '{print $6}'`
#是否需要在第一列增加行号:Y/N
this_tb_rows=`echo $this_tb_conf |awk -F'[|]'  '{print $7}'`

# --------- test ---------
# echo $1
# echo $this_tb_path
# echo $this_tb_abtest
# echo $this_tb_period
# exit 0
# --------- test ---------


#判断是否是月底
if [ $this_tb_period = "M" ]; then
   if [[  $(date +%d -d $(($(date +%Y%m%d -d "$this_etl_date 1 days" )))) = 01 ]]; then
      echo "$2"'今日需要刷新'
   else
      echo "$2"'今日不进行刷新'
      exit
   fi
fi

sed "s/etl_date/${this_etl_date}/" \
    $this_prj_root_path/hsql/template/chk_$2.sql > \
    $this_prj_root_path/hsql/$4/$5/chk_$2_now_tmp1.sql

sed "s/__site__/${4}/" \
    $this_prj_root_path/hsql/$4/$5/chk_$2_now_tmp1.sql > \
    $this_prj_root_path/hsql/$4/$5/chk_$2_now_tmp2.sql

sed "s/__lang__/${5}/" \
    $this_prj_root_path/hsql/$4/$5/chk_$2_now_tmp2.sql > \
    $this_prj_root_path/hsql/$4/$5/chk_$2_now.sql

rm -f $this_prj_root_path/hsql/$4/$5/chk_$2_now_tmp{1,2}.sql

echo "开始查询源表的数据行数..."
src_tb_row=`hive -S -f $this_prj_root_path/hsql/$4/$5/chk_$2_now.sql | grep -v WARN`
echo "源表的数据行数为"$src_tb_row
if [ -z $src_tb_row  -o $src_tb_row -le 0 ]; then
   echo "应用层没有${this_etl_date}数据，程序退出"
   exit
fi

# --------- test ---------
# cat $this_prj_root_path/hsql/$4/$5/chk_$2_now.sql
# exit 0
# --------- test ---------


#清空落地文件夹
if [ -d $this_tb_path ]; then
  echo "文件夹存在，准备删除相关文件..."
  rm -rf $this_tb_path/*$2*
fi

#重新创建目录
if [ ! -d $this_tb_path ]; then
  echo "新建数据文件目录......"
  mkdir -p $this_tb_path
fi

#调用Hive生成落地文件
if [ ! -f $this_prj_root_path/hsql/template/exp_$2.sql ]; then
    echo "落地脚本未找到，$this_prj_root_path/hsql/template/exp_$2.sql"
    exit
fi

sed "s/etl_date/${this_etl_date}/" \
    $this_prj_root_path/hsql/template/exp_$2.sql > \
    $this_prj_root_path/hsql/$4/$5/exp_$2_now_tmp1.sql

sed "s/__site__/${4}/" \
    $this_prj_root_path/hsql/$4/$5/exp_$2_now_tmp1.sql > \
    $this_prj_root_path/hsql/$4/$5/exp_$2_now_tmp2.sql

sed "s/__lang__/${5}/" \
    $this_prj_root_path/hsql/$4/$5/exp_$2_now_tmp2.sql > \
    $this_prj_root_path/hsql/$4/$5/exp_$2_now.sql

rm -f $this_prj_root_path/hsql/$4/$5/exp_$2_now_tmp{1,2}.sql

RS_EXP_EXEC=`hive -f $this_prj_root_path/hsql/$4/$5/exp_$2_now.sql`

current_path=`pwd`
cd $this_tb_path
echo "当前目录是"$current_path

#合并目录下所有的数据文件,以0开头的文件
for FILE in 0* 
 do
   echo "正在合并$this_tb_path数据文件"$FILE  
   cat $FILE >> $2_tmp_datafile.txt && rm -f ${FILE}
 done

#如果则先在第一列增加行号，列分隔符为\007
#nl -s \007 tmp_datafile.txt > datafile.txt
if [ $this_tb_rows == 'Y' ]; then
   awk '{print FNR"\007"$0}' $2_tmp_datafile.txt >$2_datafile.txt
else
   mv $2_tmp_datafile.txt $2_datafile.txt
fi
rm -rf $2_tmp_datafile.txt

# --------- test ---------
# cat $this_prj_root_path/hsql/$4/$5/exp_$2_now.sql
# exit 0
# --------- test ---------

cd $current_path
echo $this_etl_date
#查询源表数据条数
#sed "s/etl_date/${this_etl_date}/" $this_prj_root_path/hsql/chk_$2.sql > $this_prj_root_path/hsql/.chk_$2_now.sql
#src_tb_row=`hive -S -f $this_prj_root_path/hsql/.chk_$2_now.sql`

#查询落地文件中的数据行数
cd $this_tb_path
dist_file_row=`ls $this_tb_path/$2_datafile.txt|xargs cat |wc -l`
echo "落地文件中的数据行数"$dist_file_row

#创建效验文件
touch $this_tb_path/$2_$this_etl_date.chk
echo $src_tb_row\|$dist_file_row > $this_tb_path/$2_$this_etl_date.chk

if [ $src_tb_row -le 0 -o $dist_file_row -le 0 ]; then
 echo '没有落地数据，数据行数为0，请检查落地脚本.....,落地异常ERROR'
fi

#效验通过后，创建成功标记文件
if [ $src_tb_row -eq $dist_file_row ]; then
    touch $this_tb_path/$2_$this_etl_date.success
    echo "$1--->$2 $this_etl_data 数据落地成功"
  else
    echo '源表数据行数'$src_tb_row'和落地文件行数'$dist_file_row'不一致......落地异常'
fi

write_log "[INFO]" "$2" "exp_file_end" "$this_etl_date" "数据智囊$1--$2文件落地完成"
exit

```